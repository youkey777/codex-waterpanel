<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ウォーターサーバー操作パネル デモ</title>
    <style>
      :root {
        --lcd-green: #00ff66;
        --lcd-dim: rgba(0, 255, 102, 0.3);
        --lock-red: #ff3b30;
        --eco-green: #31d158;
        --panel-max: 900px;
        --spout-max: 320px;
        --stream-width: 34px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: #0f1115;
        color: #fff;
        display: flex;
        justify-content: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 24px 16px 40px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: center;
      }

      .panel-tabs {
        width: min(100%, var(--panel-max));
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 18px;
      }

      .tab-button {
        border: 2px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.85);
        border-radius: 14px;
        padding: 14px 16px;
        font-size: 16px;
        font-weight: 700;
        letter-spacing: 0.04em;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .tab-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      }

      .tab-button.is-active {
        background: #f7f7f7;
        color: #1b1f27;
        border-color: #d0d0d0;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .main-view {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: center;
        min-height: 100vh;
        justify-content: flex-start;
      }

      .panel,
      .spout {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .panel-wrap {
        width: min(100%, var(--panel-max));
        transform-origin: top center;
      }

      .panel-scale {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .panel-surface {
        background: linear-gradient(180deg, #f7f7f7, #e9e9e9);
        border-radius: 22px;
        padding: 22px 26px 26px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
        border: 1px solid #cfcfcf;
        display: grid;
        gap: 18px;
        color: #1b1f27;
        position: relative;
      }

      .panel-top {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
      }

      .panel-title {
        font-size: 14px;
        letter-spacing: 0.08em;
        color: #8a8a8a;
        text-transform: uppercase;
      }

      .panel-header {
        display: grid;
        grid-template-columns: auto auto auto;
        align-items: center;
        gap: 18px;
        justify-content: center;
      }

      .panel-status {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 56px;
        width: 100%;
      }

      .panel-status .btn-eco {
        z-index: 2;
      }

      .panel-status .lamp-row {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(120px, -50%);
      }

      .lcd {
        padding: 0 18px;
        border-radius: 6px;
        background: #1a1a1a;
        font-family: "Courier New", monospace;
        font-size: clamp(20px, 3vw, 34px);
        letter-spacing: 0.06em;
        color: var(--lcd-green);
        text-shadow: 0 0 6px rgba(0, 255, 102, 0.5);
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
        min-width: 250px;
        height: 64px;
        justify-content: center;
        border: 1px solid #2b2b2b;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
        position: relative;
      }

      .lcd.off {
        color: transparent;
        text-shadow: none;
      }

      .lcd.dim {
        color: var(--lcd-dim);
        text-shadow: none;
      }

      .lcd-value.blink,
      .lcd-unit.blink {
        animation: blink 0.6s step-end infinite;
      }

      .lcd-unit {
        position: absolute;
        right: 12px;
        bottom: 8px;
        font-size: 0.75em;
        font-family: "Segoe UI", sans-serif;
        letter-spacing: 0.02em;
        color: #c7c7c7;
        text-shadow: none;
      }

      .lcd-value,
      .lcd-unit {
        line-height: 1;
      }

      .lcd-value {
        letter-spacing: 0.32em;
      }

      .lcd-temp {
        position: absolute;
        top: 50%;
        font-size: 1em;
        font-family: "Courier New", monospace;
        letter-spacing: 0.32em;
        color: var(--lcd-green);
        text-shadow: 0 0 6px rgba(0, 255, 102, 0.45);
        opacity: 0;
        pointer-events: none;
        transform: translateY(-50%);
        text-align: center;
        width: 4ch;
        display: inline-block;
      }

      .lcd-temp.high,
      .lcd-temp.low {
        left: 50%;
      }

      .lcd-weather {
        position: absolute;
        right: 4px;
        top: 8px;
        bottom: 8px;
        display: none;
        grid-template-columns: repeat(2, 22px);
        grid-template-rows: repeat(2, 22px);
        gap: 6px;
        align-content: center;
        justify-content: center;
        opacity: 0.75;
        pointer-events: none;
      }

      .lcd-thermo {
        position: absolute;
        bottom: 6px;
        display: none;
        align-items: center;
        gap: 8px;
        opacity: 0.75;
        pointer-events: none;
      }

      .lcd-thermo.left {
        left: 26px;
      }

      .lcd-thermo.mid {
        left: 46%;
        transform: translateX(-50%);
      }

      .iot-icon {
        width: 22px;
        height: 22px;
        color: rgba(255, 255, 255, 0.8);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .iot-icon[data-weather="cloud"],
      .iot-icon[data-weather="snow"] {
        width: 30px;
        height: 30px;
      }

      .iot-icon[data-weather="cloud"] {
        margin-top: -6px;
      }

      .iot-icon[data-weather="rain"],
      .iot-icon[data-weather="snow"] {
        margin-left: -3px;
      }

      .iot-icon[data-weather="snow"] {
        margin-top: -6px;
      }

      .iot-icon[data-weather="rain"] {
        width: 24px;
        height: 24px;
      }

      .iot-thermo {
        width: 20px;
        height: 26px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .iot-users {
        display: none;
        align-items: center;
        gap: 8px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(220px, -50%);
        max-width: 100%;
      }

      .iot-only {
        display: none !important;
      }

      body[data-panel-type="iot"] .iot-only {
        display: flex !important;
      }

      body[data-panel-type="iot"] .panel-status {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
        align-items: center;
        column-gap: 12px;
      }

      body[data-panel-type="iot"] .panel-status .btn-eco {
        grid-column: 2;
        justify-self: center;
      }

      body[data-panel-type="iot"] .panel-status .lamp-row {
        grid-column: 3;
        position: static;
        transform: none;
        justify-self: start;
        gap: 10px;
      }

      body[data-panel-type="iot"] .panel-status .iot-users {
        grid-column: 3;
        position: static;
        transform: none;
        justify-self: end;
        align-self: center;
        display: flex;
        align-items: center;
        margin-top: -6px;
      }

      body[data-panel-type="iot"] .lamp-item-eco .lamp,
      body[data-panel-type="iot"] .lamp-item-lock .lamp {
        width: 9px;
        height: 9px;
      }

      body[data-panel-type="iot"] .lcd-weather {
        display: grid !important;
      }

      body[data-panel-type="iot"] .lcd-thermo {
        display: flex !important;
      }

      body[data-panel-type="iot"] .iot-users {
        display: flex !important;
      }

      body[data-panel-type="iot"] .lcd {
        --lcd-value-left: 48px;
        --lcd-value-right: 96px;
        min-width: 290px;
        padding-right: 74px;
      }

      body[data-panel-type="iot"] .lcd-unit {
        right: 58px;
        bottom: 10px;
      }

      body[data-panel-type="iot"] .lcd-value {
        position: absolute;
        left: var(--lcd-value-left);
        right: var(--lcd-value-right);
        text-align: center;
      }

      body[data-panel-type="iot"] .lcd-temp {
        width: calc((100% - var(--lcd-value-left) - var(--lcd-value-right)) / 2);
      }

      body[data-panel-type="iot"] .lcd-temp.high {
        left: var(--lcd-value-left);
      }

      body[data-panel-type="iot"] .lcd-temp.low {
        left: calc(var(--lcd-value-left) + (100% - var(--lcd-value-left) - var(--lcd-value-right)) / 2);
      }

      body[data-panel-type="iot"] .lcd-thermo.mid {
        left: calc(var(--lcd-value-left) + (100% - var(--lcd-value-left) - var(--lcd-value-right)) / 2 - 10px);
        bottom: 4px;
        transform: translateX(-50%);
      }

      body[data-panel-type="iot"] .lcd.weather-active .iot-thermo {
        opacity: 1;
      }

      body[data-panel-type="iot"] .lcd.weather-active .iot-icon.on {
        opacity: 1;
      }

      body[data-panel-type="iot"] .lcd.weather-active .lcd-temp {
        opacity: 0.9;
      }

      body[data-panel-type="iot"] .lcd.weather-active .lcd-thermo {
        color: rgba(0, 255, 102, 0.9);
      }

      .iot-user-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 2px solid #d5d5d5;
        background: #f2f2f2;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
      }

      .iot-user-btn .badge {
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 10px;
        font-weight: 700;
        color: #8a8a8a;
      }

      .iot-user-icon {
        width: 20px;
        height: 20px;
        color: #b0b0b0;
      }

      .lamp-row {
        display: flex;
        align-items: center;
        gap: 18px;
        margin-left: 0;
      }

      .lamp-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #8d8d8d;
      }

      .lamp {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        opacity: 1;
        background: #101216;
        box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.25);
        transition: all 0.2s ease;
      }

      .lamp.on.lock {
        opacity: 1;
        background: var(--lock-red);
        box-shadow: 0 0 12px rgba(255, 59, 48, 0.8);
      }

      .lamp.attention {
        animation: lampBlink 0.5s ease-in-out infinite;
        background: var(--lock-red);
        box-shadow: 0 0 14px rgba(255, 59, 48, 0.9);
        opacity: 1;
      }

      .lamp.on.eco {
        opacity: 1;
        background: var(--eco-green);
        box-shadow: 0 0 12px rgba(49, 209, 88, 0.8);
      }

      .btn {
        background: #f2f2f2;
        border: 1px solid #d4d4d4;
        color: #1b1f27;
        border-radius: 12px;
        padding: 12px 10px;
        cursor: pointer;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
        transition: transform 0.1s ease, background 0.2s ease, box-shadow 0.2s ease;
      }

      .btn:active {
        transform: translateY(2px) scale(0.98);
        box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.35), 0 1px 3px rgba(0, 0, 0, 0.2);
        background: #e0e0e0;
        border-color: #bdbdbd;
      }

      .panel-mid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        align-items: stretch;
      }

      .panel-mid .btn {
        height: 64px;
        font-size: 18px;
      }

      .btn-minus,
      .btn-plus {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        font-size: 26px;
        font-weight: 700;
        justify-self: center;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #efefef;
        border: 2px solid #d2d2d2;
        color: #b5b5b5;
      }

      .panel-bottom {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 12px;
      }

      .btn-eco {
        background: #f0f0f0;
        border: 1px solid #d8d8d8;
        color: #7a7a7a;
        height: 44px;
        width: 150px;
        font-size: 12px;
        align-self: center;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .eco-button-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        color: #bdbdbd;
      }

      .eco-button-icon svg,
      .lamp-icon svg {
        width: 100%;
        height: 100%;
      }

      .lamp-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        color: #9d9d9d;
      }

      .lamp-icon.lock-icon {
        width: 20px;
        height: 20px;
      }

      .eco-text {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.1;
      }

      .btn-hot,
      .btn-warm {
        background: #f3f3f3;
      }

      .btn-cold,
      .btn-room {
        background: #f3f3f3;
      }

      .btn-milk {
        background: #f3f3f3;
      }

      .btn-hot,
      .btn-warm,
      .btn-cold,
      .btn-room,
      .btn-milk {
        aspect-ratio: 1 / 1;
        height: 84px;
        padding: 8px 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-radius: 14px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
      }

      .btn-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        line-height: 1.1;
      }

      .btn-icon {
        width: 30px;
        height: 30px;
        color: #8b8b8b;
      }

      .btn-label {
        font-size: 12px;
        color: #8b8b8b;
      }

      .btn-lock {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.08em;
        color: #9a1d1d;
        display: inline-block;
        margin-left: 6px;
      }

      .btn-lock-icon {
        display: inline-block;
        width: 14px;
        height: 12px;
        margin-left: 0;
        border: 2px solid #9a1d1d;
        border-radius: 3px;
        position: relative;
        box-sizing: border-box;
        position: absolute;
        top: 6px;
        left: 6px;
      }

      .btn-lock-icon::before {
        content: "";
        position: absolute;
        width: 8px;
        height: 6px;
        border: 2px solid #9a1d1d;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        box-sizing: border-box;
      }

      .eco-note {
        display: block;
        font-size: 10px;
        font-weight: 600;
        color: #9a9a9a;
        letter-spacing: 0.02em;
      }

      .spout-wrap {
        width: min(100%, var(--spout-max));
        position: relative;
        display: flex;
        justify-content: center;
        padding: 20px 0 40px;
      }

      .spout-body {
        width: 100%;
        max-width: 360px;
        height: 210px;
        background: linear-gradient(180deg, #f7f8fb, #d6dae2);
        border-radius: 18px;
        box-shadow: 0 16px 26px rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(0, 0, 0, 0.12);
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 28px;
        overflow: hidden;
      }

      .spout-body::before {
        content: "";
        position: absolute;
        inset: 10px;
        border-radius: 16px;
        background: linear-gradient(180deg, #f2f3f6, #cfd3dd);
        box-shadow: inset 0 10px 18px rgba(0, 0, 0, 0.15);
        z-index: 0;
      }

      .spout-nozzle {
        width: calc(100% - 24px);
        height: 34px;
        background: #2a2f36;
        border-radius: 10px;
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.15);
        z-index: 4;
      }

      .spout-mouth {
        width: 52px;
        height: 12px;
        background: #111318;
        border-radius: 4px;
        position: absolute;
        top: 56px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.1);
        z-index: 4;
      }

      .spout-tray {
        position: absolute;
        bottom: 14px;
        width: 82%;
        height: 22px;
        background: linear-gradient(180deg, #c2c7d2, #aeb4c0);
        border-radius: 0 0 16px 16px;
        box-shadow: inset 0 8px 10px rgba(0, 0, 0, 0.25);
        z-index: 1;
      }

      .spout-tray::after {
        content: "";
        position: absolute;
        inset: 4px 8px;
        border-radius: 0 0 12px 12px;
        background: linear-gradient(90deg, rgba(120, 160, 210, 0.1), rgba(120, 160, 210, 0.45), rgba(120, 160, 210, 0.1));
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .spout-tray.wet::after {
        opacity: 1;
        animation: trayWet 0.9s ease-in-out infinite;
      }

      .spout-drip {
        position: absolute;
        top: 64px;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 6px;
        background: #20242b;
        border-radius: 2px;
        z-index: 3;
      }

      .cup {
        width: 88px;
        height: 96px;
        position: relative;
        background: #ffffff;
        border-radius: 6px 6px 16px 16px;
        border: 2px solid #c9ced8;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.2);
        margin-top: 8px;
        z-index: 2;
        overflow: hidden;
      }

      .cup-fill {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 0%;
        background: rgba(100, 150, 255, 0.5);
        transition: height 0.2s linear;
      }

      .cup-overflow {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 10px;
        background: rgba(100, 150, 255, 0.5);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .cup.overflowing .cup-overflow {
        opacity: 1;
      }

      .cup.overflowing::before {
        content: "";
        position: absolute;
        left: -6px;
        right: -6px;
        top: 8px;
        height: 8px;
        background: rgba(100, 150, 255, 0.35);
        border-radius: 6px;
        filter: blur(0.5px);
      }

      .spill {
        position: absolute;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 110px;
        opacity: 0;
        pointer-events: none;
        z-index: 1;
      }

      .spill.on {
        opacity: 1;
      }

      .spill::before,
      .spill::after {
        content: "";
        position: absolute;
        top: 0;
        width: 22px;
        height: 100%;
        background: linear-gradient(180deg, rgba(100, 150, 255, 0.55), rgba(100, 150, 255, 0.05));
        border-radius: 10px;
        animation: spillFlow 0.9s linear infinite;
      }

      .spill::before {
        left: 18px;
      }

      .spill::after {
        right: 18px;
        animation-delay: 0.2s;
      }

      @keyframes spillFlow {
        0% {
          transform: translateY(-10px);
          opacity: 0.3;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          transform: translateY(22px);
          opacity: 0.3;
        }
      }

      @keyframes trayWet {
        0% {
          opacity: 0.4;
        }
        50% {
          opacity: 0.85;
        }
        100% {
          opacity: 0.4;
        }
      }

      .cup::after {
        content: "";
        position: absolute;
        right: -14px;
        top: 26px;
        width: 22px;
        height: 38px;
        border: 3px solid #c9ced8;
        border-left: none;
        border-radius: 0 14px 14px 0;
      }

      .stream {
        position: absolute;
        left: 50%;
        top: 88px;
        transform: translateX(-50%);
        width: calc(var(--stream-width) / 2);
        height: 0;
        border-radius: 0 0 12px 12px;
        opacity: 0;
        transition: height 0.2s ease, opacity 0.2s ease;
        z-index: 3;
      }

      .stream.on {
        height: 90px;
        opacity: 0.9;
      }

      .hint {
        margin: 0;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }

      .notes {
        width: min(100%, 720px);
        background: #15171c;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        color: rgba(255, 255, 255, 0.75);
        margin-top: 8px;
      }

      .notes h3 {
        margin: 0 0 8px;
        font-size: 14px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.85);
      }

      .notes textarea {
        width: 100%;
        min-height: 120px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: #0f1115;
        color: #e6e6e6;
        padding: 10px 12px;
        font-size: 13px;
        line-height: 1.5;
      }

      .rules {
        width: min(100%, 720px);
        background: #121418;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        color: rgba(255, 255, 255, 0.75);
        font-size: 12px;
        line-height: 1.6;
        margin-top: 8px;
      }

      .rules h3 {
        margin: 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
      }

      .rules-header {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rules-toggle {
        width: 16px;
        height: 16px;
        padding: 0;
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        cursor: pointer;
        opacity: 0.6;
        line-height: 1;
      }

      .rules-toggle:hover {
        opacity: 0.9;
      }

      .rules-content {
        display: none;
        margin-top: 8px;
      }

      .rules-content.is-open {
        display: block;
      }

      .rule-section {
        margin-top: 10px;
      }

      .rule-section h4 {
        margin: 0 0 4px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
      }

      .rules ul {
        margin: 0;
        padding-left: 18px;
      }

      @keyframes blink {
        50% {
          opacity: 0;
        }
      }

      @keyframes lampBlink {
        0%,
        100% {
          opacity: 0.2;
        }
        50% {
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .page {
          padding: 18px 12px 32px;
        }

        .panel-surface {
          padding: 16px;
        }

        .panel-mid .btn {
          height: 56px;
          font-size: 16px;
        }

        .btn-hot,
        .btn-warm,
        .btn-cold,
        .btn-room,
        .btn-milk {
          height: 72px;
        }

        .btn-icon {
          width: 26px;
          height: 26px;
        }

        .stream {
          top: 92px;
          height: 70px;
        }
      }

      @media (min-width: 700px) and (max-width: 900px) {
        .panel-wrap {
          width: min(100%, 720px);
        }

        .panel-surface {
          padding: 18px 20px 22px;
          gap: 14px;
        }

        .btn-hot,
        .btn-warm,
        .btn-cold,
        .btn-room,
        .btn-milk {
          height: 82px;
        }
      }

      @media (max-width: 480px) {
        .page {
          padding: 14px 10px 28px;
        }

        .panel-tabs {
          gap: 10px;
        }

        .tab-button {
          font-size: 14px;
          padding: 12px 10px;
        }

        .panel-header {
          gap: 12px;
        }

        .panel-bottom {
          grid-template-columns: repeat(5, minmax(0, 1fr));
        }

        .btn-hot,
        .btn-warm,
        .btn-cold,
        .btn-room,
        .btn-milk {
          height: 64px;
        }

        .btn-icon {
          width: 24px;
          height: 24px;
        }

        .btn-label {
          font-size: 10px;
        }

        body[data-panel-type="iot"] .panel-header {
          gap: 8px;
        }

        body[data-panel-type="iot"] .lcd {
          min-width: 0;
          width: 100%;
          max-width: 200px;
          height: 52px;
          font-size: clamp(17px, 5.2vw, 26px);
        }

        body[data-panel-type="iot"] .btn-minus,
        body[data-panel-type="iot"] .btn-plus {
          width: 40px;
          height: 40px;
          font-size: 20px;
        }

        body[data-panel-type="iot"] .btn-eco {
          height: 40px;
          width: 104px;
          font-size: 10px;
        }

        body[data-panel-type="iot"] .panel-status {
          grid-template-columns: minmax(0, 0.9fr) auto minmax(0, 1.1fr);
          grid-template-areas: "lamp eco users";
          column-gap: 8px;
        }

        body[data-panel-type="iot"] .panel-status .lamp-row {
          grid-area: lamp;
          grid-column: 1;
          justify-self: start;
          gap: 6px;
        }

        body[data-panel-type="iot"] .panel-status .btn-eco {
          grid-area: eco;
          grid-column: 2;
          justify-self: center;
        }

        body[data-panel-type="iot"] .panel-status .iot-users {
          grid-area: users;
          grid-column: 3;
          justify-self: end;
          gap: 4px;
        }

        body[data-panel-type="iot"] .lamp-item-eco .lamp,
        body[data-panel-type="iot"] .lamp-item-lock .lamp {
          width: 9px;
          height: 9px;
        }

        body[data-panel-type="iot"] .iot-user-btn {
          width: 22px;
          height: 22px;
        }

        body[data-panel-type="iot"] .iot-user-icon {
          width: 11px;
          height: 11px;
        }

        body[data-panel-type="iot"] .panel-bottom {
          gap: 8px;
        }

        body[data-panel-type="iot"] .btn-hot,
        body[data-panel-type="iot"] .btn-warm,
        body[data-panel-type="iot"] .btn-cold,
        body[data-panel-type="iot"] .btn-room,
        body[data-panel-type="iot"] .btn-milk {
          height: 58px;
        }

        body[data-panel-type="iot"] .btn-icon {
          width: 22px;
          height: 22px;
        }

        body[data-panel-type="iot"] .btn-label {
          font-size: 9px;
        }

        .lamp-item-eco .lamp,
        .lamp-item-lock .lamp {
          width: 9px;
          height: 9px;
        }

        .lamp-item-lock {
          margin-left: -6px;
        }

      }

      @media (min-width: 900px) and (min-height: 900px) {
        :root {
          --panel-max: 980px;
          --spout-max: 420px;
        }

        .panel-surface {
          padding: 26px 30px 30px;
        }
      }

      @media (max-width: 420px) {
        .page {
          padding: 12px 8px 24px;
          gap: 18px;
        }

        .panel-tabs {
          gap: 8px;
        }

        .panel-surface {
          padding: 12px;
          gap: 14px;
        }

        .main-view {
          gap: 18px;
        }
        .panel-wrap {
          transform: scale(0.92);
        }

        .panel-bottom {
          grid-template-columns: repeat(5, minmax(0, 1fr));
        }

        body[data-panel-type="iot"] .panel-status {
          grid-template-areas: "lamp eco users";
          column-gap: 6px;
        }

        body[data-panel-type="iot"] .panel-status .lamp-row {
          justify-self: start;
        }

        body[data-panel-type="iot"] .panel-status .btn-eco {
          justify-self: center;
        }

        body[data-panel-type="iot"] .panel-status .iot-users {
          justify-self: end;
        }

        body[data-panel-type="iot"] .btn-eco {
          width: 104px;
        }

        body[data-panel-type="iot"] .iot-user-btn {
          width: 22px;
          height: 22px;
        }

        body[data-panel-type="iot"] .iot-user-icon {
          width: 11px;
          height: 11px;
        }

        .lamp-item-eco .lamp,
        .lamp-item-lock .lamp {
          width: 9px;
          height: 9px;
        }

        .lamp-item-lock {
          margin-left: -8px;
        }
      }
    </style>
  </head>
  <body data-panel-type="normal">
    <div class="page">
      <div class="panel-tabs" role="tablist" aria-label="操作パネル切替">
        <button class="tab-button is-active" type="button" role="tab" aria-selected="true" data-tab="normal">ノーマル</button>
        <button class="tab-button" type="button" role="tab" aria-selected="false" data-tab="iot">IoT</button>
      </div>
      <div class="main-view">
        <section class="panel">
          <div class="panel-wrap">
            <div class="panel-surface">
            <div class="panel-top">
              <div class="panel-title">Operation Panel</div>
            </div>

            <div class="panel-header">
              <button class="btn btn-minus" data-action="minus" aria-label="量を減らす">-</button>
              <div class="lcd dim" id="lcd">
                <span class="lcd-value" id="lcd-value">----</span>
                <span class="lcd-unit" id="lcd-unit">ml</span>
                <span class="lcd-temp high iot-only" id="temp-high" aria-hidden="true">--</span>
                <span class="lcd-temp low iot-only" id="temp-low" aria-hidden="true">--</span>
                <div class="lcd-thermo left iot-only" aria-hidden="true">
                  <svg class="iot-thermo" viewBox="0 0 24 24">
                    <rect x="10" y="3" width="4" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="18" r="4" fill="none" stroke="currentColor" stroke-width="2" />
                    <path d="M12 7v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="lcd-thermo mid iot-only" aria-hidden="true">
                  <svg class="iot-thermo" viewBox="0 0 24 24">
                    <rect x="10" y="3" width="4" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="18" r="4" fill="none" stroke="currentColor" stroke-width="2" />
                    <path d="M12 10v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="lcd-weather iot-only" aria-hidden="true">
                  <svg class="iot-icon weather-icon" data-weather="sun" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2" />
                    <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.5 4.5l2.2 2.2M17.3 17.3l2.2 2.2M4.5 19.5l2.2-2.2M17.3 6.7l2.2-2.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  <svg class="iot-icon weather-icon" data-weather="rain" viewBox="0 0 24 24">
                    <path d="M4 12a8 8 0 0 1 16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M4 12c2 2 4 2 6 0c2 2 4 2 6 0c2 2 4 2 6 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 12v5a2 2 0 0 0 4 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  <svg class="iot-icon weather-icon" data-weather="cloud" viewBox="0 0 24 24">
                    <path d="M6 14a4 4 0 0 1 7.6-1.8A3.5 3.5 0 1 1 16 19H7a3 3 0 0 1-1-5.9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  <svg class="iot-icon weather-icon" data-weather="snow" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="3" fill="none" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="15" r="4" fill="none" stroke="currentColor" stroke-width="2" />
                    <circle cx="11" cy="7" r="0.6" fill="currentColor" />
                    <circle cx="13" cy="7" r="0.6" fill="currentColor" />
                    <path d="M12 10v2M12 13v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
              </div>
              <button class="btn btn-plus" data-action="plus" aria-label="量を増やす">+</button>
            </div>

            <div class="panel-status">
              <button class="btn btn-eco" data-action="eco" aria-label="エコ切替">
                <span class="eco-button-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 2a6.5 6.5 0 0 0-3.9 11.7L9 16v2h6v-2l0.9-2.3A6.5 6.5 0 0 0 12 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                    <path d="M9.5 21h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M10 18h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </span>
                <span class="eco-text">
                  <span>ECO</span>
                  <span class="eco-note">/ キャンセル</span>
                </span>
              </button>
              <div class="lamp-row">
                <div class="lamp-item lamp-item-eco">
                  <span class="lamp eco" id="lamp-eco" aria-hidden="true"></span>
                  <span class="lamp-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2a6.5 6.5 0 0 0-3.9 11.7L9 16v2h6v-2l0.9-2.3A6.5 6.5 0 0 0 12 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                      <path d="M9.5 21h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      <path d="M10 18h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </span>
                </div>
                <div class="lamp-item lamp-item-lock">
                  <span class="lamp lock" id="lamp-lock" aria-hidden="true"></span>
                  <span class="lamp-icon lock-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="6" y="10" width="12" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2" />
                      <path d="M16.5 10V6a4 4 0 0 0-7.5-2.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      <path d="M16.5 10l2.2 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </span>
                </div>
              </div>
              <div class="iot-users iot-only" aria-hidden="true">
                <div class="iot-user-btn">
                  <span class="badge">1</span>
                  <svg class="iot-user-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4" fill="currentColor" />
                    <path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" fill="currentColor" />
                  </svg>
                </div>
                <div class="iot-user-btn">
                  <span class="badge">2</span>
                  <svg class="iot-user-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4" fill="currentColor" />
                    <path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" fill="currentColor" />
                  </svg>
                </div>
                <div class="iot-user-btn">
                  <span class="badge">3</span>
                  <svg class="iot-user-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4" fill="currentColor" />
                    <path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" fill="currentColor" />
                  </svg>
                </div>
                <div class="iot-user-btn">
                  <span class="badge">4</span>
                  <svg class="iot-user-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4" fill="currentColor" />
                    <path d="M4 20c1.5-4 6-6 8-6s6.5 2 8 6" fill="currentColor" />
                  </svg>
                </div>
              </div>
            </div>

            <div class="panel-bottom">
              <button class="btn btn-hot" data-action="hot" aria-label="温水">
                <span class="btn-lock-icon" aria-hidden="true"></span>
                <span class="btn-content">
                  <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M6 18c-2-2-2-4 0-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 18c-2-2-2-4 0-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M18 18c-2-2-2-4 0-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  <span class="btn-label">温水</span>
                </span>
              </button>
              <button class="btn btn-warm" data-action="warm" aria-label="白湯">
                <span class="btn-lock-icon" aria-hidden="true"></span>
                <span class="btn-content">
                  <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3c2 3 4 5 4 8a4 4 0 1 1-8 0c0-3 2-5 4-8z" fill="none" stroke="currentColor" stroke-width="2" />
                    <path d="M18 18c-1.5-1.5-1.5-3 0-4.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  <span class="btn-label">白湯</span>
                </span>
              </button>
              <button class="btn btn-cold" data-action="cold" aria-label="冷水">
                <span class="btn-content">
                  <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3c2 3 4 5 4 8a4 4 0 1 1-8 0c0-3 2-5 4-8z" fill="none" stroke="currentColor" stroke-width="2" />
                    <path d="M12 12v6M9 15h6M10 13l4 4M14 13l-4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                  </svg>
                  <span class="btn-label">冷水</span>
                </span>
              </button>
              <button class="btn btn-room" data-action="room" aria-label="常温水">
                <span class="btn-content">
                  <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3c2 3 4 5 4 8a4 4 0 1 1-8 0c0-3 2-5 4-8z" fill="none" stroke="currentColor" stroke-width="2" />
                  </svg>
                  <span class="btn-label">常温水</span>
                </span>
              </button>
              <button class="btn btn-milk" data-action="milk" aria-label="粉ミルク">
                <span class="btn-lock-icon" aria-hidden="true"></span>
                <span class="btn-content">
                  <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="7" y="5" width="10" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" />
                    <rect x="9" y="3" width="6" height="3" rx="1" fill="none" stroke="currentColor" stroke-width="2" />
                  </svg>
                  <span class="btn-label">粉ミルク</span>
                </span>
              </button>
            </div>
            </div>
          </div>
        </section>

        <p class="hint">ボタンはHTML/CSSで再現しています。</p>

        <section class="spout">
          <div class="spout-wrap">
            <div class="spout-body" aria-label="取水口">
              <div class="spout-nozzle"></div>
              <div class="spout-mouth"></div>
              <div class="spout-drip"></div>
              <div class="cup" id="cup" aria-hidden="true">
                <div class="cup-fill" id="cup-fill"></div>
                <div class="cup-overflow"></div>
              </div>
              <div class="spill" id="spill" aria-hidden="true"></div>
              <div class="spout-tray" id="spout-tray" aria-hidden="true"></div>
            </div>
            <div class="stream" id="stream"></div>
          </div>
        </section>
      </div>

      <section class="notes">
        <h3>メモ</h3>
        <textarea placeholder="ここにメモを書いてください"></textarea>
      </section>

      <section class="rules">
        <div class="rules-header">
          <button class="rules-toggle" type="button" aria-expanded="false" aria-controls="rules-content">▽</button>
        </div>

        <div class="rules-content" id="rules-content">
          <div class="rule-section">
          <h4>デフォルト</h4>
          <ul>
            <li>量指定なし：押している間だけ出水、離すと停止、液晶は表示しない</li>
            <li>量指定あり：1タップで出水継続、液晶は点滅</li>
            <li>取水完了後は液晶の数値が消える</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>量指定（+ / -）</h4>
          <ul>
            <li>初回押下は150表示のみ、2回目以降10mlずつ増減</li>
            <li>無操作が続くと数値は消える（約15秒）</li>
            <li>量指定→ロック解除でも表示はリセットされない</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>冷水・常温水</h4>
          <ul>
            <li>ロック不要、量なしは押しっぱなし、量ありは自動取水</li>
            <li>冷水/常温水は共通メモリ（前回量指定した量がメモリされる）</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>温水・白湯</h4>
          <ul>
            <li>3秒長押し解除、解除に使ったボタンのみ取水可能</li>
            <li>取水完了後5秒で再ロック（量指定などの液晶表示は残る）</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>ロック解除と取水のルール</h4>
          <ul>
            <li>ロック解除に使ったボタンでしか取水できない</li>
            <li>別の温水系ボタンを押すと無効になり再度ロック掛かる</li>
            <li>ロック解除中でも冷水/常温水は自由量のみ取水可（量指定は不可）</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>粉ミルク</h4>
          <ul>
            <li>ロック解除+量指定必須、60%温水→40%冷水</li>
            <li>温水後の待機中は、温水/白湯/冷水/常温水を押しても液晶の量だけ点滅し、残りの冷水排出は粉ミルク（または冷水/常温水）で行われる</li>
            <li>2回目完了で液晶消去</li>
            <li>温水完了時は温水ランプ消え、再度ロック状態（ランプ消える事で冷水いけるの意味）</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>例外（ロック解除中）</h4>
          <ul>
            <li>冷水や常温水も、量指定は不可/液晶消去/再ロックかかる</li>
            <li>冷水/常温水の自由量取水後、最後の操作から5秒で再ロック</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>指定量メモリ</h4>
          <ul>
            <li>冷水と常温水は共通のメモリ</li>
            <li>ロック解除が必要な水は、解除に使ったボタンに記憶</li>
            <li>量指定中に別ボタンを押すと取水がキャンセルされる</li>
            <li>量指定→ロック解除という挙動の場合は、ロック解除に使った取水ボタンに記憶</li>
            <li>記憶値から始めたい時は先にロック解除→量指定することでロック解除に使ったボタンのメモリ量から始まる</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>ECO</h4>
          <ul>
            <li>短押しでON/OFF、長押し1秒でキャンセル（液晶表示戻る、温水ロックかかる）</li>
          </ul>
        </div>

        <div class="rule-section">
          <h4>アニメーション</h4>
          <ul>
            <li>色：冷水=青/常温=薄青/温水=橙/白湯=薄橙/粉ミルク=クリーム</li>
            <li>量なし出水はゆっくり溜まり、満杯後は溢れ+受け皿濡れ</li>
          </ul>
        </div>
        </div>
      </section>
    </div>

    <script>
      const MIN_AMOUNT = 10;
      const MAX_AMOUNT = 5000;
      const STEP = 10;
      const HOLD_INTERVAL = 100;
      const HOLD_DELAY = 400;
      const UNLOCK_HOLD = 3000;
      const DISPENSE_DURATION = 3500;
      const DISPLAY_CLEAR_DELAY = 15000;
      const RELock_DELAY = 5000;
      const ECO_HOLD_CANCEL = 1000;

      const COLORS = {
        cold: "#6496FF",
        room: "#C8DCFF",
        hot: "#FF6432",
        warm: "#FFB464",
        milkWarm: "#FFF2D6",
        milkCold: "#CFE3FF"
      };

      const state = {
        amount: null,
        isLocked: true,
        ecoMode: false,
        isDispensing: false,
        dispenseMode: null,
        dispensingType: null,
        pendingAction: null,
        milkPhase: 0,
        milkTotal: 0,
        unlockButton: null,
        unlockTriggered: false,
        lockBlinkArmed: false,
        lockBlinkPointerId: null,
        memory: {
          coldRoom: 150,
          hot: 150,
          warm: 150,
          milk: 150
        },
        timers: {
          hold: null,
          holdDelay: null,
          unlock: null,
          dispense: null,
          relock: null,
          blink: null,
          amountBlink: null,
          displayClear: null,
          overflow: null,
          lampBlink: null
        }
      };

      const lcd = document.getElementById("lcd");
      const lcdValue = document.getElementById("lcd-value");
      const lcdUnit = document.getElementById("lcd-unit");
      const lampLock = document.getElementById("lamp-lock");
      const lampEco = document.getElementById("lamp-eco");
      const stream = document.getElementById("stream");
      const cupFill = document.getElementById("cup-fill");
      const cup = document.getElementById("cup");
      const spill = document.getElementById("spill");
      const spoutTray = document.getElementById("spout-tray");
      const tempHigh = document.getElementById("temp-high");
      const tempLow = document.getElementById("temp-low");
      const weatherIcons = document.querySelectorAll(".weather-icon");

      const buttons = document.querySelectorAll(".btn");
      const tabButtons = document.querySelectorAll(".tab-button");
      const rulesToggle = document.querySelector(".rules-toggle");
      const rulesContent = document.getElementById("rules-content");

      let currentTab = "normal";
      const WEATHER_DISPLAY_DELAY = 10000;
      const WEATHER_BLINK_ON = 700;
      const WEATHER_GAP_SHORT = 160;
      const WEATHER_GAP_LONG = 900;
      const WEATHER_PATTERNS = [
        ["sun"],
        ["cloud"],
        ["rain"],
        ["snow"],
        ["sun", "cloud"],
        ["cloud", "sun"],
        ["cloud", "rain"],
        ["rain", "cloud"],
        ["snow", "cloud"],
        ["cloud", "snow"],
        ["sun", "rain"]
      ];

      const weatherState = {
        active: false,
        hideTimer: null,
        cycleTimer: null,
        temps: null,
        sequence: null
      };

      function setActiveTab(tabName) {
        currentTab = tabName;
        document.body.dataset.panelType = tabName;
        tabButtons.forEach((button) => {
          const isActive = button.dataset.tab === tabName;
          button.classList.toggle("is-active", isActive);
          button.setAttribute("aria-selected", String(isActive));
        });
        if (tabName !== "iot") {
          stopWeatherDisplay();
        }
      }

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const nextTab = button.dataset.tab || "normal";
          if (nextTab === currentTab) return;
          setActiveTab(nextTab);
        });
      });

      setActiveTab("normal");

      if (rulesToggle && rulesContent) {
        rulesToggle.addEventListener("click", () => {
          const isOpen = rulesContent.classList.toggle("is-open");
          rulesToggle.setAttribute("aria-expanded", String(isOpen));
          rulesToggle.textContent = isOpen ? "△" : "▽";
        });
      }

      function clampAmount(value) {
        return Math.min(MAX_AMOUNT, Math.max(MIN_AMOUNT, value));
      }

      function getMemoryBase() {
        if (!state.isLocked && state.unlockButton) {
          return state.memory[state.unlockButton] || 150;
        }
        return state.memory.coldRoom || 150;
      }

      function setAmount(value) {
        stopWeatherDisplay();
        state.amount = clampAmount(value);
        updateLCD();
        scheduleDisplayClear();
      }

      function clearAmount() {
        state.amount = null;
        updateLCD();
        clearTimeout(state.timers.displayClear);
      }

      function updateLCD() {
        const hasAmount = state.amount !== null;
        if (hasAmount) {
          const amountText = String(state.amount);
          const padded = amountText.padStart(4, "\u00A0");
          lcdValue.textContent = padded;
        } else {
          lcdValue.textContent = "";
        }
        lcd.classList.toggle("dim", !hasAmount);
        lcd.classList.toggle("off", !hasAmount);
      }

      function setLCDBlink(on) {
        lcdValue.classList.toggle("blink", on);
      }

      function blinkAmountValue() {
        if (state.amount === null) return;
        setLCDBlink(true);
        clearTimeout(state.timers.amountBlink);
        state.timers.amountBlink = setTimeout(() => {
          setLCDBlink(false);
        }, 1200);
      }

      function blinkUnit() {
        lcdValue.classList.add("blink");
        clearTimeout(state.timers.blink);
        state.timers.blink = setTimeout(() => {
          lcdValue.classList.remove("blink");
        }, 2000);
      }

      function setEco(on) {
        state.ecoMode = on;
        lampEco.classList.toggle("on", on);
      }

      function setWeatherIconsOff() {
        weatherIcons.forEach((icon) => {
          icon.classList.remove("on");
        });
      }

      function setWeatherIconOn(type) {
        weatherIcons.forEach((icon) => {
          if (icon.dataset.weather === type) {
            icon.classList.add("on");
          }
        });
      }

      function pickWeatherPattern() {
        const pick = WEATHER_PATTERNS[Math.floor(Math.random() * WEATHER_PATTERNS.length)];
        return pick.slice();
      }

      function pickTemperaturePair() {
        const seasons = [
          { minRange: [0, 8], maxRange: [8, 16] },
          { minRange: [6, 13], maxRange: [14, 22] },
          { minRange: [18, 26], maxRange: [27, 35] },
          { minRange: [5, 12], maxRange: [13, 21] }
        ];
        const season = seasons[Math.floor(Math.random() * seasons.length)];
        const min = season.minRange[0] + Math.floor(Math.random() * (season.minRange[1] - season.minRange[0] + 1));
        const maxBase = season.maxRange[0] + Math.floor(Math.random() * (season.maxRange[1] - season.maxRange[0] + 1));
        const max = Math.max(maxBase, min + 3);
        return {
          high: String(max).padStart(2, "0"),
          low: String(min).padStart(2, "0")
        };
      }

      function startWeatherCycle(sequence) {
        clearTimeout(weatherState.cycleTimer);
        setWeatherIconsOff();
        if (sequence.length === 1) {
          setWeatherIconOn(sequence[0]);
          return;
        }
        let step = 0;
        const tick = () => {
          if (!weatherState.active) return;
          const type = sequence[step % sequence.length];
          setWeatherIconsOff();
          setWeatherIconOn(type);
          setTimeout(() => {
            setWeatherIconsOff();
          }, WEATHER_BLINK_ON);
          const delay = step % sequence.length === 0
            ? WEATHER_BLINK_ON + WEATHER_GAP_SHORT
            : WEATHER_BLINK_ON + WEATHER_GAP_LONG;
          weatherState.cycleTimer = setTimeout(() => {
            step = (step + 1) % sequence.length;
            tick();
          }, delay);
        };
        tick();
      }

      function showWeatherDisplay() {
        if (currentTab !== "iot") return;
        if (!lcd) return;
        weatherState.active = true;
        lcd.classList.add("weather-active");
        clearTimeout(weatherState.hideTimer);
        const temps = pickTemperaturePair();
        weatherState.temps = temps;
        if (tempHigh) tempHigh.textContent = temps.high;
        if (tempLow) tempLow.textContent = temps.low;
        const sequence = pickWeatherPattern();
        weatherState.sequence = sequence;
        startWeatherCycle(sequence);
      }

      function scheduleWeatherHide(delayMs) {
        clearTimeout(weatherState.hideTimer);
        if (!weatherState.active) return;
        weatherState.hideTimer = setTimeout(() => {
          stopWeatherDisplay();
        }, delayMs);
      }

      function stopWeatherDisplay() {
        weatherState.active = false;
        clearTimeout(weatherState.hideTimer);
        clearTimeout(weatherState.cycleTimer);
        setWeatherIconsOff();
        if (lcd) lcd.classList.remove("weather-active");
        if (tempHigh) tempHigh.textContent = "--";
        if (tempLow) tempLow.textContent = "--";
      }

      function setLock(on, options = {}) {
        const keepAmount = options.keepAmount === true;
        state.isLocked = on;
        lampLock.classList.toggle("on", !on);
        lampLock.classList.remove("attention");
        if (on) {
          if (state.unlockButton && !keepAmount) {
            clearAmount();
          }
          state.unlockButton = null;
          state.pendingAction = null;
        }
      }

      function startRelockTimer() {
        clearTimeout(state.timers.relock);
        state.timers.relock = setTimeout(() => {
          setLock(true, { keepAmount: true });
        }, RELock_DELAY);
      }

      function unlockHot(buttonType) {
        setLock(false);
        state.unlockButton = buttonType;
        startRelockTimer();
        if (state.amount === null) {
          clearAmount();
        }
      }

      function blinkLockLamp() {
        if (!lampLock) return;
        if (!state.isLocked) return;
        lampLock.classList.remove("attention");
        void lampLock.offsetWidth;
        lampLock.classList.add("attention");
        clearTimeout(state.timers.lampBlink);
        state.timers.lampBlink = setTimeout(() => {
          lampLock.classList.remove("attention");
        }, 1800);
      }

      function scheduleDisplayClear() {
        clearTimeout(state.timers.displayClear);
        state.timers.displayClear = setTimeout(() => {
          if (!state.isDispensing) {
            clearAmount();
          }
        }, DISPLAY_CLEAR_DELAY);
      }

      function setStream(active, color) {
        if (active) {
          stream.classList.add("on");
          stream.style.background = color;
        } else {
          stream.classList.remove("on");
          stream.style.background = "transparent";
        }
      }

      function hexToRgba(hex, alpha) {
        const raw = hex.replace("#", "");
        const r = parseInt(raw.substring(0, 2), 16);
        const g = parseInt(raw.substring(2, 4), 16);
        const b = parseInt(raw.substring(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function setCupFill(active, duration, color, allowOverflow) {
        if (!cupFill) return;
        cupFill.style.transitionDuration = `${duration}ms`;
        if (active) {
          cupFill.style.background = hexToRgba(color, 0.45);
          cupFill.style.height = "100%";
          if (cup) {
            cup.classList.remove("overflowing");
          }
          if (spill) {
            spill.classList.remove("on");
          }
          if (spoutTray) {
            spoutTray.classList.remove("wet");
          }
          clearTimeout(state.timers.overflow);
          if (allowOverflow && cup) {
            state.timers.overflow = setTimeout(() => {
              if (state.isDispensing && state.dispenseMode === "hold") {
                cup.classList.add("overflowing");
                if (spill) {
                  spill.classList.add("on");
                }
                if (spoutTray) {
                  spoutTray.classList.add("wet");
                }
              }
            }, 2500);
          }
        } else {
          cupFill.style.height = "0%";
          if (cup) {
            cup.classList.remove("overflowing");
          }
          if (spill) {
            spill.classList.remove("on");
          }
          if (spoutTray) {
            spoutTray.classList.remove("wet");
          }
          clearTimeout(state.timers.overflow);
        }
      }

      function startDispensing(type, mode, amount, showLCD) {
        state.isDispensing = true;
        state.dispenseMode = mode;
        state.dispensingType = type;
        setLCDBlink(Boolean(showLCD));
        setStream(true, COLORS[type]);
        clearTimeout(state.timers.displayClear);
        clearTimeout(state.timers.relock);
        if (type === "hot" || type === "warm") {
          setLock(false);
        }
        if (mode === "auto") {
          setCupFill(true, DISPENSE_DURATION, COLORS[type], false);
        } else {
          setCupFill(true, 2800, COLORS[type], true);
        }

        if (mode === "auto") {
          clearTimeout(state.timers.dispense);
          state.timers.dispense = setTimeout(() => {
            finishDispensing(true);
          }, DISPENSE_DURATION);
        }
        if (mode === "hold" && type !== "milk" && type !== "milkWarm" && type !== "milkCold") {
          showWeatherDisplay();
        }
      }

      function finishDispensing(complete) {
        const lastMode = state.dispenseMode;
        const lastType = state.dispensingType;
        const isMilkWarmPhase = state.dispensingType === "milkWarm" && state.milkPhase === 1;
        const isMilkColdPhase = state.dispensingType === "milkCold";
        const isHotDispense = state.dispensingType === "hot" || state.dispensingType === "warm";
        clearTimeout(state.timers.dispense);
        setLCDBlink(false);
        setStream(false, "transparent");
        setCupFill(false, 200, COLORS.cold, false);
        state.isDispensing = false;
        state.dispenseMode = null;
        state.dispensingType = null;

        if (!complete) {
          clearAmount();
          state.milkPhase = 0;
          state.milkTotal = 0;
        }

        if (isMilkWarmPhase) {
          setLock(true, { keepAmount: true });
        } else if (complete && !isMilkWarmPhase) {
          clearAmount();
        }

        if (isHotDispense) {
          setLock(false);
          startRelockTimer();
        } else if (!state.isLocked && !isMilkWarmPhase && !isMilkColdPhase) {
          startRelockTimer();
        }

        if (complete) {
          if (lastMode === "auto") {
            if (lastType === "milkCold") {
              showWeatherDisplay();
              scheduleWeatherHide(WEATHER_DISPLAY_DELAY);
            } else if (lastType !== "milkWarm") {
              showWeatherDisplay();
              scheduleWeatherHide(WEATHER_DISPLAY_DELAY);
            }
          }
          if (lastMode === "hold" && lastType !== "milk" && lastType !== "milkWarm" && lastType !== "milkCold") {
            scheduleWeatherHide(WEATHER_DISPLAY_DELAY);
          }
        }
      }

      function cancelDispensing() {
        if (!state.isDispensing) return;
        finishDispensing(false);
      }

      function rememberAmount(type, amount) {
        if (type === "cold" || type === "room") {
          state.memory.coldRoom = amount;
        } else if (type === "hot") {
          state.memory.hot = amount;
        } else if (type === "warm") {
          state.memory.warm = amount;
        } else if (type === "milk") {
          state.memory.milk = amount;
        }
      }

      function adjustAmount(delta) {
        if (state.amount === null) {
          setAmount(getMemoryBase());
          return;
        }
        setAmount(state.amount + delta);
      }

      function handlePlusMinus(action) {
        if (state.isDispensing && state.dispenseMode === "auto") {
          cancelDispensing();
          return;
        }
        if (state.milkPhase === 1 && !state.isDispensing) {
          blinkAmountValue();
          return;
        }
        if (state.amount === null) {
          setAmount(getMemoryBase());
          return;
        }
        adjustAmount(action === "plus" ? STEP : -STEP);
        if (!state.isLocked) startRelockTimer();
      }

      function handleEcoPress(isLong) {
        if (isLong) {
          cancelDispensing();
          stopWeatherDisplay();
          clearAmount();
          state.milkPhase = 0;
          state.milkTotal = 0;
          state.pendingAction = null;
          if (!state.isLocked) {
            setLock(true, { keepAmount: true });
          }
          return;
        }
        if (state.isDispensing && state.dispenseMode === "auto") {
          cancelDispensing();
          return;
        }
        setEco(!state.ecoMode);
      }

      function requireUnlock() {
        if (state.isLocked) {
          return false;
        }
        startRelockTimer();
        return true;
      }

      function beginDispensePress(type) {
        if (state.isDispensing && state.dispenseMode === "auto") {
          cancelDispensing();
          return;
        }

        const isHotGroup = type === "hot" || type === "warm" || type === "milk";
        if (state.milkPhase === 1) {
          if (type === "cold" || type === "room") {
            blinkAmountValue();
            state.pendingAction = "milk";
            return;
          }
          if (type === "hot" || type === "warm") {
            blinkAmountValue();
            return;
          }
          if (type === "milk") {
            state.pendingAction = "milk";
            return;
          }
        }
        if (isHotGroup && state.isLocked && !(type === "milk" && state.milkPhase === 1)) {
          blinkLockLamp();
          return;
        }
        if (!state.isLocked && state.unlockButton && isHotGroup && type !== state.unlockButton) {
          state.lockBlinkArmed = false;
          state.lockBlinkPointerId = null;
          setLock(true);
          clearAmount();
          return;
        }
        if (!state.isLocked && state.unlockButton && !isHotGroup && state.amount !== null) {
          state.lockBlinkArmed = false;
          state.lockBlinkPointerId = null;
          setLock(true);
          clearAmount();
          return;
        }
        if (type === "milk") {
          if (state.amount === null) {
            blinkUnit();
            return;
          }
          state.pendingAction = "milk";
          return;
        }

        if (state.amount !== null) {
          state.pendingAction = type;
          return;
        }

        startDispensing(type, "hold", 0, false);
      }

      function endDispensePress() {
        if (state.dispenseMode === "hold") {
          finishDispensing(true);
        }
      }

      function startQueuedDispense() {
        if (!state.pendingAction) return;
        const type = state.pendingAction;
        state.pendingAction = null;

        if (type === "milk") {
          if (state.milkPhase === 1) {
            startDispensing("milkCold", "auto", state.milkTotal * 0.4, true);
            state.milkPhase = 0;
            state.milkTotal = 0;
            return;
          }
          if (state.amount === null) {
            blinkUnit();
            return;
          }
          if (state.milkPhase === 0) {
            state.milkTotal = state.amount;
            rememberAmount("milk", state.amount);
            startDispensing("milkWarm", "auto", state.amount * 0.6, true);
            state.milkPhase = 1;
            return;
          }
        }

        if (state.amount !== null) {
          rememberAmount(type, state.amount);
          startDispensing(type, "auto", state.amount, true);
        }
      }

      function setupButtonHandlers() {
        buttons.forEach((button) => {
          const action = button.dataset.action;

          if (action === "plus" || action === "minus") {
            button.addEventListener("pointerdown", (event) => {
              event.preventDefault();
              handlePlusMinus(action);
              clearInterval(state.timers.hold);
              clearTimeout(state.timers.holdDelay);
              state.timers.holdDelay = setTimeout(() => {
                state.timers.hold = setInterval(() => {
                  handlePlusMinus(action);
                }, HOLD_INTERVAL);
              }, HOLD_DELAY);
            });
            button.addEventListener("pointerup", () => {
              clearInterval(state.timers.hold);
              clearTimeout(state.timers.holdDelay);
            });
            button.addEventListener("pointerleave", () => {
              clearInterval(state.timers.hold);
              clearTimeout(state.timers.holdDelay);
            });
            return;
          }

          if (action === "eco") {
            let longPressed = false;
            button.addEventListener("pointerdown", (event) => {
              event.preventDefault();
              longPressed = false;
              clearTimeout(state.timers.holdDelay);
              state.timers.holdDelay = setTimeout(() => {
                longPressed = true;
                handleEcoPress(true);
              }, ECO_HOLD_CANCEL);
            });
            button.addEventListener("pointerup", () => {
              clearTimeout(state.timers.holdDelay);
              if (!longPressed) handleEcoPress(false);
            });
            button.addEventListener("pointerleave", () => {
              clearTimeout(state.timers.holdDelay);
            });
            return;
          }

          if (action === "hot" || action === "warm" || action === "milk") {
            button.addEventListener("pointerdown", (event) => {
              event.preventDefault();
              if (state.milkPhase === 1 && (action === "hot" || action === "warm")) {
                blinkAmountValue();
                state.lockBlinkArmed = false;
                state.lockBlinkPointerId = null;
                return;
              }
              if (state.milkPhase === 1 && action === "milk") {
                beginDispensePress(action);
                return;
              }
              state.lockBlinkArmed = true;
              state.lockBlinkPointerId = event.pointerId;
              if (state.isDispensing && state.dispenseMode === "auto") {
                cancelDispensing();
                return;
              }
              if (action === "milk" && state.milkPhase === 1) {
                beginDispensePress(action);
                return;
              }
              if (!state.isLocked) {
                beginDispensePress(action);
                return;
              }
              state.unlockTriggered = false;
              clearTimeout(state.timers.unlock);
              state.timers.unlock = setTimeout(() => {
                state.unlockTriggered = true;
                unlockHot(action);
              }, UNLOCK_HOLD);
            });
            button.addEventListener("pointerup", (event) => {
              clearTimeout(state.timers.unlock);
              if (
                state.isLocked &&
                !state.unlockTriggered &&
                state.lockBlinkArmed &&
                state.lockBlinkPointerId === event.pointerId
              ) {
                blinkLockLamp();
              }
              state.lockBlinkArmed = false;
              state.lockBlinkPointerId = null;
              endDispensePress();
              startQueuedDispense();
            });
            button.addEventListener("pointerleave", (event) => {
              clearTimeout(state.timers.unlock);
              if (
                state.isLocked &&
                !state.unlockTriggered &&
                state.lockBlinkArmed &&
                state.lockBlinkPointerId === event.pointerId
              ) {
                blinkLockLamp();
              }
              state.lockBlinkArmed = false;
              state.lockBlinkPointerId = null;
              endDispensePress();
            });
            return;
          }

          if (action === "cold" || action === "room") {
            button.addEventListener("pointerdown", (event) => {
              event.preventDefault();
              beginDispensePress(action);
            });
            button.addEventListener("pointerup", () => {
              endDispensePress();
              startQueuedDispense();
            });
            button.addEventListener("pointerleave", () => {
              endDispensePress();
            });
          }
        });
      }

      function init() {
        updateLCD();
        setEco(false);
        setLock(true);
        setupButtonHandlers();
      }

      init();
    </script>
  </body>
</html>
